---
title: "自问自答-http"
date: 2020-11-27
slug: "myself question and answer about http"
draft: false
tags:
- TECH
- Http
categories:
- TECH
---

# 一、从前端提交URL说起

1. 先根据域名解析找到目标服务器
2. 与服务器建立连接，发送请求
3. 后端服务器解析请求后处理，并返回相应html内容
4. 客户端解析响应内容，根据需求再次发起请求获取静态资源
5. 页面渲染后展示

# 二、为什么需要域名解析？

​	   主要是为了方便可读。目前我们常用的网络通讯是基于TCP/IP协助的，而在这个过程中，对于机器来说，ip是唯一可识别的信息，但是对于人来说，一个人很难去记住各种由几串数字组合成的ip地址。因此，我们需要一个更容易记住，可读性也更强的域名，再通过域名解析的方式，来解决人与机器之间的认知差异。

# 三、域名解析是怎么做的？

1. 首先是从浏览器本地缓存查找域名映射地址。注意，存在且未过期，才是有效ip。
2. 如果本地缓存找不到，就进一步尝试从本机缓存获取。即当前机器系统内的host配置
3. 本机缓存也没有，则需要请求DNS服务器获取

# 四、DNS服务器查询IP的过程是怎样的

1. 浏览器向本地配置的首选DNS服务器A发起请求
2. 服务器A首先检查自身机器的缓存是否存在匹配的信息，是则返回，否则走3
3. 服务器A向根服务器获取相应顶级域名服务器(比如说.com域名服务器)的IP地址，然后再向该顶级域名服务器发起请求查询。
4. 如果顶级域名服务器也不存在此信息，则会返回权威域名服务器的ip，服务器A可以再试着去权威域名服务器查询。
5. 一般来说，以上4步已经可以准确定位到一个域名对应的IP地址

![img](https://i.loli.net/2021/01/24/zPm6Gc8ZyBhVCQg.jpg)

# 五、DNS 服务器会占用哪些端口？

1. 比较特别的是，DNS服务器是需要同时占用TCP与UDP端口的
2. 在前边我们提起的前端提交URL后做的域名解析过程中，DNS使用的是UDP协议，因为本身响应体较小，而且可能请求会特别多且频繁，用UDP协议可以使用DNS的负载更低，响应更快
3. 而除此之外，其实DNS服务器也存在主从服务器的概念，从服务器从主服务器获取该区的DNS信息这一过程，叫做区传送。由于传送数据较多，且对数据的准确性有一定要求，所以使用的是TCP协议

# 六、 TCP 与 UDP的区别

| TCP                      | UDP                        |
| ------------------------ | -------------------------- |
| 面向字节流               | 面向报文                   |
| 需要建立连接，只能一对一 | 不需要建立连接，可以一对多 |
| 具备可靠性，传输效率低   | 不保证数据可靠，效率高     |
| 有流量控制与拥塞控制     | 不做控制                   |

# 七、面向字节流与面向报文分别是什么？

1. UDP是面向报文的，它的主要思路是，尽最大努力交付，即客户端发送一个报文，服务端就立马接收一个。
2. TCP是面向字节流的，在服务端的缓冲区够用的前提下，客户端提交的数据是先积压在缓冲区，服务端可以一次性读取。这就是我们常说的TCP无边界。
   - 无边界的机制很容易导致出现黏包的情况。比如说客户端发送两次 10AABB，但如果服务端接收得快，客户端发送较慢(一般可能是网络原因导致的)，会出现，服务端先接收到 10AA， 再接收到BB10AABB，这种情况我们就叫做黏包。
   - 如何发现黏包？
     - 常用的处理方式是在网络协议之上再做一层封装，定义好包头，记录好包长度，以及首尾检查位，方便TCP做校验。
   - 如何解决黏包？
     - 对于发送方引起的现象，TCP支持强制推送数据的指令，不需要等发送缓存区满
     - 对于接收方引起的现象，常用的方式是由接收方按包结构字段分多次接收，再做合并。此方式用样适用于解决发送方引起的现象

# 八、TCP 连接建立与关闭

1. 三次握手

   - 图示

   ![三次握手](https://i.loli.net/2021/01/24/3tfBC6kTsMyPKQo.png)

   - 为什么需要三次握手？
     - 一句话，主要防止已经失效的连接请求报文突然又传送到了服务器，从而产生错误。
     - 三次握手的过程，确定了客户端与服务器双方的收发能力都处于可用状态；同时也确定了本次连接持续期间的有效报文序列号起点，可以有效的防止在网络延迟下，前一个连接的报文被下一个新建立的连接接收到的情况。

2. 四次挥手

   - 图示

   ![image-20210124155503338](https://i.loli.net/2021/01/24/R6Ko8sAXITzEqiF.png)

   - 为什么需要4次？
     - 简单的说，
       - 当客户端想要关闭连接的时候，会给服务端一个FIN信息，这只能代表客户端不再发了，服务端的接收能力可以不要了，但是服务端可能还有数据没发完，所以客户端的接收能力是不能关的
       - 只有等到服务端主要告诉客户端，我也发完了，不需要你的接收能力了，这时候，才能完全关闭这条连接。
   - 为什么客户端要等待2MSL?
     - 等待的原因是考虑到可能服务端会收不到我们的ACK信息，可能会要求重传；如果直接关闭，服务端的重传请求就无法被正确处理，可能导致服务端的连接无法被政策关闭
     - 而为什么是2MSL呢？主要是因为一个报文在网络中的生存最大时间就是1MSL，而一来一回，正好是2MSL

# 九、从socket编程的角度说说网络通信的过程

   1. 服务端通过socket函数建立一个socket套接字A
   2. 接着服务端使用bind函数绑定一个ip与port，然后调用listen函数，进入监听状态，等待客户端连接
   3. 然后是客户端也通过socket函数建立一个socket套接字，并设置远程ip与port
   4. 接着客户端调用connect函数，请求与服务端建立连接
   5. 服务端使用accept函数接收，双方进入三次握手阶段
   6. 三次握手后，连接建立成功，双方都可以使用read/write函数往各自的套接字中读/写数据

# 十、 TCP/IP模型

![image.png](https://i.loli.net/2021/01/24/k2Gm3wFVLvUzX6a.png)

# 十一、报文格式

1. http报文
   - 第一行 - http版本、url、请求方式
   - 第二行 - 头部信息
   - 第三行 - (get请求没有)，请求body信息
2. tcp首部报文(关键字段)
   - 源端口和目的端口，各占2个字节，分别写入源端口和目的端口；
   - 序号，占4个字节，TCP连接中传送的字节流中的每个字节都按顺序编号。
   - 确认号，占4个字节，是期望收到对方下一个报文的第一个数据字节的序号。
   - 确认ACK，仅当ACK=1时，确认号字段才有效。
   - 同步SYN，在连接建立时用来同步序号。当SYN=1，ACK=0，表明是连接请求报文，若同意连接，则响应报文中应该使SYN=1，ACK=1；
   - 终止FIN，用来释放连接。当FIN=1，表明此报文的发送方的数据已经发送完毕，并且要求释放；
   - 窗口，占2字节，指的是通知接收方，发送本报文你需要有多大的空间来接受；
   - 检验和，占2字节，校验首部和数据这两部分；

# 十二、TCP如何保证可靠性？

TCP 是通过序列号、确认应答、重发控制、连接管理以及窗口控制等机制实现可靠性传输的。

![img](https://i.loli.net/2021/01/24/bYzAlDBL1n8kEsd.png)

# 十三、post请求报文格式选择

| 报文格式                          | 应对场景                                                     |
| --------------------------------- | ------------------------------------------------------------ |
| application/x-www-form-urlencoded | 原生form默认提交方式，提交的数据将会格式化成类似username=111&age=2的形式。 |
| multipart/form-data               | 文件上传                                                     |
| application/json                  | 较为常见的json交互                                           |
| application/xml、text/html        | 根据实际使用场景下的数据格式选择                             |

# 十三、流量控制与拥塞控制

1. 什么是流量控制？
   - 流量控制是为了避免在发的快，收的慢的情况下，导致数据丢失
   - 其主要采取的手段是滑动窗口。简单来说，就是连接建立时，接收方会告诉发送方，我的最大接收能力是xx，然后在后续的实际交付过程中， 发送方再根据实际情况控制这个窗口值。
   - 考虑传输效率的前提下，还支持多种机制控制发送时间
     - 缓冲区到达数据已经达到一半发送窗口大小，或者是最大报文长度，立即发送
     - 发送方主动强制推送
     - 发送方计时定期强制推送
2. 拥塞控制手段
   1. 慢开始
      - 设定一个慢开始门限值，ssthresh
      - 连接刚建立，窗口从1开始，逐渐增长，每次只把窗口大小加倍
   2. 拥塞避免
      - 当窗口大于ssthresh，采用拥塞避免，不再直接加倍，而是只加1
   3. 快重传
      - 这里是让接收方每收到一个失序的报文，就立即要求重传，而不是等到自己发送数据的时候，再捎带通知
   4. 快恢复
      - 快恢复是跟快重传配合的，当发送方连续收到几个快重传请求，则触发快恢复，将慢开始门限值，ssthresh减半，并设置为当前窗口值，然后开始执行拥塞避免。

# 十四、http1与http2

http2的优化项如下

1. 头部压缩
2. 多路复用
3. 服务端主动推送

# 十五、https验签过程

- 首先，客户端发起握手请求，以明文传输请求信息，包含版本信息，加密-套件候选列表，压缩算法候选列表，随机数，扩展字段等信息(`这个没什么好说的，就是用户在浏览器里输入一个HTTPS网址，然后连接到服务端的443端口。`)

- 服务端的配置，采用HTTPS协议的服务器必须要有一套数字证书，可以自己制作，也可以向组织申请。区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面。`这套证书其实就是一对公钥和私钥。`如果对公钥不太理解，可以想象成一把钥匙和一个锁头，只是世界上只有你一个人有这把钥匙，你可以把锁头给别人，别人可以用这个锁把重要的东西锁起来，然后发给你，因为只有你一个人有这把钥匙，所以只有你才能看到被这把锁锁起来的东西。

- 服务端返回协商的信息结果，包括选择使用的协议版本 version，选择的加密套件 cipher suite，选择的压缩算法 compression method、随机数 random_S 以及证书。(`这个证书其实就是公钥，只是包含了很多信息，如证书的颁发机构，过期时间等等。`)

- 客户端验证证书的合法性，包括可信性，是否吊销，过期时间和域名。(`这部分工作是由客户端的SSL/TLS来完成的，首先会验证公钥是否有效，比如颁发机构，过期时间等等，如果发现异常，则会弹出一个警示框，提示证书存在的问题。如果证书没有问题，那么就生成一个随机值。然后用证书（也就是公钥）对这个随机值进行加密。就好像上面说的，把随机值用锁头锁起来，这样除非有钥匙，不然看不到被锁住的内容。`)

- 客户端使用公匙对对称密匙加密，发送给服务端。(`这部分传送的是用证书加密后的随机值，目的是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密了。`)

- 服务器用私钥解密，拿到对称加密的密匙。(`服务端用私钥解密后，得到了客户端传过来的随机值，然后把内容通过该随机值进行对称加密，将信息和私钥通过某种算法混合在一起，这样除非知道私钥，不然无法获取内容，而正好客户端和服务端都知道这个私钥，所以只要加密算法够彪悍，私钥够复杂，数据就够安全。`)

- 传输加密后的信息，这部分信息就是服务端用私钥加密后的信息，可以在客户端用随机值解密还原。

- 客户端解密信息，客户端用之前生产的私钥解密服务端传过来的信息，于是获取了解密后的内容。整个过程第三方即使监听到了数据，也束手无策。

# 参考资料

## [一次完整的Http事务(脑图)](https://www.processon.com/view/link/56c6679ce4b0f0c4285e69c0#map)

## [TCP VS UDP](https://blog.csdn.net/ce123_zhouwei/article/details/8976006)

## [http报文格式](https://www.pianshen.com/article/64671790350/)

## [HTTPS加密过程](https://www.jianshu.com/p/e30a8c4fa329)

## [TCP 流量控制](https://blog.csdn.net/yechaodechuntian/article/details/25429143)

